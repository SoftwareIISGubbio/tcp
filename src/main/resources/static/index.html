<!DOCTYPE html>
<html>
  <head>
	<meta charsewt="UTF-8">
  	<title>IOT monitor</title>
  	<style>
      body {background-color: #EECD00}
      menu { background-color:#eeeeee; border-radius: 0.5rem; padding:1rem}
      #tela { border: 1px solid black }
  	</style>
  </head>
  <body onload="avvia()">
	<menu>
	  <img src="iiscg.png" style="height:1.5rem; padding-right: 2rem ;">
	  <select id="cosaVoglio">
		<option value="20" selected="selected">ultimi 20</option>
		<option value="storico">storico</option>
	  </select>
	  <input type="text" id="giorno" value="2023-11-09">
	  <input type="checkbox" id="live" value="live" checked>live
	  <button type="button" style="float:right" onclick="avvia()">aggiorna</button>
    </menu>
	<div>
	  <canvas id="tela" width="650" height="450"></canvas> 
	  <img src="qr.png" style="width:10rem">
	</div>
	<div id="risposta"></div>
  </body>
  <script>
"use strict";

let richiestaAlServer;
let disegno = tela.getContext("2d");
disegno.textAlign = "center";

let orologio = new Intl.DateTimeFormat('it-IT',{
  dateStyle: 'full',
  timeStyle: 'long'
});

/* solare corrente con max 400 */
/* tensione eolico con max 5 */
let cosa="tensione";
let altezza=300;
let ampiezza=30;
let max = 5; 
let timer = window.setTimeout(null,1);
let server = "http://kili.aspix.it:8008";
let indirizzoDati="/20";

function avvia(){
  clearInterval(timer);
  if(cosaVoglio.value=="storico"){
    indirizzoDati = server+"/statistiche/giornata?giorno="+giorno.value; // 2023-11-09
  }else{
    indirizzoDati = server+"/20";
  }
  if(live.checked){
	timer = window.setInterval(aggiornaGrafico, 1000);	
  }else{
    aggiornaGrafico();	
  }
}

function successoQualcosa(){
  if (richiestaAlServer.readyState === XMLHttpRequest.DONE) {    
    if(richiestaAlServer.status == 200){
      let elencoMisure = JSON.parse(richiestaAlServer.responseText);
	  elencoMisure = elencoMisure.reverse();
	
	  // pulisco la tela		
	  disegno.fillStyle = "#000000";
      disegno.clearRect(0, 0, tela.width, tela.height)
      disegno.beginPath();
	  disegno.moveTo(20, 400);
	  disegno.lineTo(640, 400);
	  disegno.stroke();
			
	  if(elencoMisure.length<20){ // troppi pochi dati, qualcosa non va
	    disegno.fillText("dati insufficienti", 400, 200);
      }else{			
		let ultimoTempo = new Date(elencoMisure[19]["ts"]);
        disegno.fillText(orologio.format(ultimoTempo), 300, 420);
				
		// traccio i valori delle ordinate
		for(let t=1;t<=10;t++){
		  disegno.beginPath();
		  disegno.moveTo(0, 400-(altezza/10*t));
		  disegno.lineTo(20, 400-(altezza/10*t));
          disegno.closePath();
          disegno.fillText(t*10+"%", 20, 400-(altezza/10*t));
        }
	
		// disegno il grafico
		disegno.fillStyle = "#ff0000";
		disegno.beginPath();
				
		for(let i=0 ; i<elencoMisure.length ; i++){
		  let dato = Number(elencoMisure[i][cosa]);
		  let val = (dato/max)*altezza;
		  if(i==0){
            disegno.moveTo(ampiezza*(i+2), 400-val);
          } else {
            disegno.lineTo(ampiezza*(i+2), 400-val);
          }
          let etichetta = dato.toString().substring(0,4)
          disegno.fillText(etichetta, ampiezza*(i+2), 400-val-10);
        }
      }
	  disegno.stroke();
    }else{
      document.getElementById("risposta").innerHTML = "errore "+richiestaAlServer.status;
    }
  }
}

function aggiornaGrafico(){
  richiestaAlServer = new XMLHttpRequest();
  richiestaAlServer.onreadystatechange = successoQualcosa;
  richiestaAlServer.open('GET', indirizzoDati);
  richiestaAlServer.send();
}
</script>
</html>